name: Test Orchestrator

# Allows a “Run workflow” button in the Actions tab
on:
  workflow_dispatch: {}

jobs:
  test-unit-tests:
    - name: "Unit Tests"
    runs-on: ubuntu-latest
    steps:
      - name: Download and extract Unit Test Repo
        run: |
          echo "Downloading unit testing repository..."
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-units-f25-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o unit-test.zip
          unzip -q unit-test.zip -d unit-test
      - name: Install pytest
        run: pip install pytest pytest-spec pytest-describe
      - name: Run pytest
        run: pytest --spec unit-test/testing-units-f25-OliverOlsenUT-main
  test-system-tests:
    - name: "System Tests"
    runs-on: ubuntu-latest
    steps:
      - name: Download Behave Repo
        run: |
          echo "Downloading behave repository..."
          # This command downloads the main branch as a .zip file.
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-with-behave-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o behave.zip

      - name: Download Unit Test Repo
        run: |
          echo "Downloading unit testing repository..."
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-units-f25-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o unit-test.zip

      - name: Download Testing Systems Repo
        run: |
          echo "Downloading Testing Systems repository..."
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-systems-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o systems.zip
          unzip -q systems.zip -d systems
          
      - name: Install pytest
        run: pip install pytest pytest-spec pytest-describe
      - name: Run pytest
        run: |
          cd systems/testing-systems-OliverOlsenUT-main
          pytest --spec .
  behave-test-cipher:
    name: (Behave Tests) Test Cipher App
    runs-on: ubuntu-latest
    steps:
      - name: Download Behave Repo
        run: |
          echo "Downloading behave repository..."
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-with-behave-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o behave.zip
          unzip -q behave.zip -d behave

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Use Python 3.11 as requested

      - name: Add ChromeDriver to PATH
        run: echo "$CHROMEWEBDRIVER" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install behave==1.2.6 behave-webdriver==0.3.1 selenium==3.141.0 urllib3==1.26.18 six==1.16.0
          
      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run Cipher Tests
        working-directory: ./behave/testing-with-behave-OliverOlsenUT-main/cipher
        run: |
          echo "Running tests in the 'cipher' directory..."
          echo "--- Verifying versions ---"
          echo "ChromeDriver: $(chromedriver --version)"
          echo "Google Chrome: $(google-chrome --version)"
          echo "Python: $(python --version)"
          echo "--------------------------"
          xvfb-run python -m behave features/
          # -----------------------------------------------------------------

  # Job for the 'isitchristmas' application
  behave-test-isitchristmas:
    name: (Behave Tests) Test IsItChristmas App
    runs-on: ubuntu-latest
    steps:
      - name: Download Behave Repo
        run: |
          echo "Downloading behave repository..."
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-with-behave-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o behave.zip
          unzip -q behave.zip -d behave

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Use Python 3.11 as requested

      - name: Add ChromeDriver to PATH
        run: echo "$CHROMEWEBDRIVER" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install behave==1.2.6 behave-webdriver==0.3.1 selenium==3.141.0 urllib3==1.26.18 six==1.16.0

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run IsItChristmas Tests
        working-directory: ./behave/testing-with-behave-OliverOlsenUT-main/isitchristmas
        run: |
          echo "Running tests in the 'isitchristmas' directory..."
          echo "--- Verifying versions ---"
          echo "ChromeDriver: $(chromedriver --version)"
          echo "Google Chrome: $(google-chrome --version)"
          echo "Python: $(python --version)"
          echo "--------------------------"
          xvfb-run python -m behave features/
          # -----------------------------------------------------------------

  # Job for the 'peppers-ghost' application
  behave-test-peppers-ghost:
    name: (Behave Tests) Test Peppers-Ghost App
    runs-on: ubuntu-latest
    steps:
      - name: Download Behave Repo
        run: |
          echo "Downloading behave repository..."
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-with-behave-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o behave.zip
          unzip -q behave.zip -d behave

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Use Python 3.11 as requested

      - name: Add ChromeDriver to PATH
        run: echo "$CHROMEWEBDRIVER" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install behave==1.2.6 behave-webdriver==0.3.1 selenium==3.141.0 urllib3==1.26.18 six==1.16.0

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run Peppers-Ghost Tests
        working-directory: ./behave/testing-with-behave-OliverOlsenUT-main/peppers-ghost
        run: |
          echo "Running tests in the 'peppers-ghost' directory..."
          echo "--- Verifying versions ---"
          echo "ChromeDriver: $(chromedriver --version)"
          echo "Google Chrome: $(google-chrome --version)"
          echo "Python: $(python --version)"
          echo "--------------------------"
          xvfb-run python -m behave features/
          # -----------------------------------------------------------------


  # Job for the 'squirrel_app' application (using Docker)
  behave-test-squirrel-app:
    name: (Behave Tests) Test Squirrel App
    runs-on: ubuntu-latest
    steps:
      - name: Download Behave Repo
        run: |
          echo "Downloading behave repository..."
          curl \
            -L "https://github.com/JeffCompasClassrooms/testing-with-behave-OliverOlsenUT/archive/refs/heads/main.zip" \
            -o behave.zip
          unzip -q behave.zip -d behave
          
      # Add Python setup for Behave runner
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Use Python 3.11 as requested

      # Add ChromeDriver for Behave runner
      - name: Add ChromeDriver to PATH
        run: echo "$CHROMEWEBDRIVER" >> $GITHUB_PATH

      # Install Behave dependencies on the runner
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install behave==1.2.6 behave-webdriver==0.3.1 selenium==3.141.0 urllib3==1.26.18 six==1.16.0

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Build and run Docker container
        working-directory: ./behave/testing-with-behave-OliverOlsenUT-main/squirrel_app
        run: |
          docker build -t squirrel-app .
          docker run -d -p 8080:8080 -p 8000:8000 --name squirrel-container squirrel-app
          
      - name: Wait for servers to start and test endpoints
        run: |
          echo "Waiting for servers to start..."
          sleep 10 # Give the servers time to initialize
          
          echo "Testing static server (port 8000)..."
          # This will fail if the server doesn't return a 2xx/3xx status
          curl -f http://localhost:8000
          
          echo "Testing squirrel server (port 8080)..."
          # Removed -f flag. A 404 is OK, it just means the server is running.
          curl http://localhost:8080
          
      # Run Behave tests against the running container
      - name: Run Squirrel App Tests
        working-directory: ./behave/testing-with-behave-OliverOlsenUT-main/squirrel_app
        run: |
          echo "Running tests in the 'squirrel_app' directory..."
          echo "--- Verifying versions ---"
          echo "ChromeDriver: $(chromedriver --version)"
          echo "Google Chrome: $(google-chrome --version)"
          echo "Python: $(python --version)"
          echo "--------------------------"
          # Run behave, which will test against http://localhost:8080/8000
          xvfb-run python -m behave features/

      - name: Stop and remove container
        # This step runs even if the test step fails, to ensure cleanup
        if: always()
        run: |
          echo "Stopping and removing Docker container..."
          docker stop squirrel-container
          docker rm squirrel-container
      
      